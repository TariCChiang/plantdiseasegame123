<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>植物病害防禦戰：防疫大師 (Pro Mobile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; padding: 0; background-color: #000; overflow: hidden; 
            font-family: 'Microsoft JhengHei', sans-serif; 
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { background-color: #051005; display: block; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; padding: 15px; }
        .hud-text { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9); font-weight: bold; }
        
        #target-display {
            position: absolute; left: 15px; top: 80px;
            background: rgba(0, 40, 0, 0.85); border: 1px solid #4ade80;
            padding: 10px; border-radius: 8px; width: 150px; pointer-events: none;
        }
        
        /* 射擊按鈕樣式 */
        #fire-button {
            position: absolute;
            bottom: 40px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: rgba(220, 38, 38, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* 允許點擊 */
            z-index: 60;
            backdrop-filter: blur(4px);
            transition: transform 0.1s;
        }
        #fire-button:active {
            transform: scale(0.9);
            background: rgba(220, 38, 38, 0.7);
        }
        #fire-button::after {
            content: "FIRE";
            color: white;
            font-weight: 900;
            font-size: 18px;
        }

        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        .btn {
            background: linear-gradient(135deg, #16a34a, #14532d); color: white;
            padding: 12px 40px; border-radius: 50px; font-size: 20px; cursor: pointer;
            border: 2px solid #4ade80; transition: 0.3s; margin-top: 20px; pointer-events: auto;
        }
        .level-up-anim {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 50px; font-weight: 900; color: #fde047; text-shadow: 0 0 20px #16a34a;
            animation: levelUpFade 2s forwards; pointer-events: none; z-index: 50;
        }
        @keyframes levelUpFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(1); }
        }
        .wrong-flash { animation: flashRed 0.4s; }
        @keyframes flashRed { 0% { background: transparent; } 50% { background: rgba(255,0,0,0.3); } 100% { background: transparent; } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <!-- 虛擬按鍵 -->
    <div id="fire-button"></div>
    
    <div id="ui-layer">
        <div class="flex justify-between items-start">
            <div>
                <div id="level-title" class="hud-text text-xl text-yellow-400">載入中...</div>
                <div class="hud-text text-base text-green-400">得分: <span id="score-val">0</span> / <span id="next-goal">3000</span></div>
            </div>
            <div class="hud-text text-xl text-red-500">❤️ <span id="lives-val">10</span></div>
        </div>

        <div id="target-display">
            <div class="text-[10px] text-green-300 font-bold mb-0.5 uppercase">Target</div>
            <div id="target-name" class="text-lg font-black text-white leading-tight">---</div>
            <div id="target-desc" class="text-[11px] text-gray-300 leading-tight">擊落正確病原體</div>
        </div>
        
        <div class="absolute bottom-4 left-4 text-gray-400 text-[10px] font-medium">
            左手拖曳移動 • 右手按紅鈕射擊
        </div>
    </div>

    <div id="menu-overlay">
        <h1 id="menu-title" class="text-4xl font-black text-green-500 mb-4 tracking-tighter hud-text text-center px-4">植物病害防禦戰</h1>
        <div id="game-over-msg" class="max-w-xs text-center text-gray-200 px-4 mb-6 text-sm">
            看清左側顯示的<span class="text-green-400 font-bold">中文名稱</span>，<br>擊落攜帶對應<span class="text-yellow-400 font-bold">學名</span>的病原體。<br><br>
            <span class="text-red-400">優化：</span>左手移動戰機，<br>右手點擊右下角 <span class="font-bold">FIRE</span> 鈕射擊！
        </div>
        <button id="start-btn" class="btn">開始防疫行動</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameContainer = document.getElementById('game-container');
    const scoreEl = document.getElementById('score-val');
    const livesEl = document.getElementById('lives-val');
    const goalEl = document.getElementById('next-goal');
    const levelTitleEl = document.getElementById('level-title');
    const targetNameEl = document.getElementById('target-name');
    const targetDescEl = document.getElementById('target-desc');
    const menuOverlay = document.getElementById('menu-overlay');
    const startBtn = document.getElementById('start-btn');
    const fireBtn = document.getElementById('fire-button');

    const LEVEL_DATA = [
        {
            name: "第一關：真菌病害",
            goal: 3000,
            type: "fungi",
            diseases: [
                { cn: "稻熱病", sci: "Pyricularia oryzae", info: "梭形病斑中央灰白", color: "#6ee7b7" },
                { cn: "白粉病", sci: "Erysiphe spp.", info: "表面白色粉狀黴層", color: "#f8fafc" },
                { cn: "霜霉病", sci: "Peronospora spp.", info: "葉背灰紫黴層", color: "#93c5fd" },
                { cn: "炭疽病", sci: "Colletotrichum spp.", info: "果實凹陷黑斑", color: "#c084fc" },
                { cn: "疫病", sci: "Phytophthora spp.", info: "喜積水高濕", color: "#fb7185" }
            ]
        },
        {
            name: "第二關：細菌病害",
            goal: 6000,
            type: "bacteria",
            diseases: [
                { cn: "青枯病", sci: "R. solanacearum", info: "迅速萎凋但葉仍綠", color: "#bef264" },
                { cn: "軟腐病", sci: "P. carotovorum", info: "組織腐爛散發惡臭", color: "#84cc16" },
                { cn: "柑橘潰瘍病", sci: "X. citri", info: "隆起潰瘍狀有黃暈", color: "#fbbf24" }
            ]
        },
        {
            name: "第三關：病毒病害",
            goal: 10000,
            type: "virus",
            diseases: [
                { cn: "黃葉捲曲病", sci: "TYLCV", info: "葉捲曲、變黃、矮化", color: "#fde047" },
                { cn: "花葉病", sci: "CMV", info: "深淺綠花葉，蚜蟲媒介", color: "#4ade80" },
                { cn: "輪點病", sci: "PRSV", info: "同心圓狀輪紋", color: "#f97316" }
            ]
        }
    ];

    let currentLevelIdx = 0;
    let gameState = 'MENU';
    let score = 0;
    let lives = 10;
    let frameCount = 0;
    let currentTarget = null;
    let player = null;
    let bullets = [];
    let enemies = [];
    let particles = [];
    let stars = [];

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    for (let i = 0; i < 40; i++) {
        stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2, speed: Math.random() * 1 + 0.2 });
    }

    class Player {
        constructor() { 
            this.x = canvas.width / 2; 
            this.y = canvas.height - 150; 
            this.targetX = this.x; 
            this.targetY = this.y; 
            this.speed = 0.28; 
            this.invincible = 0; 
        }
        update() {
            this.x += (this.targetX - this.x) * this.speed;
            this.y += (this.targetY - this.y) * this.speed;
            this.x = Math.max(30, Math.min(canvas.width - 30, this.x));
            this.y = Math.max(30, Math.min(canvas.height - 30, this.y));
            if (this.invincible > 0) this.invincible--;
        }
        draw() {
            if (this.invincible > 0 && frameCount % 6 < 3) return;
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(20, 10); ctx.lineTo(0, 0); ctx.lineTo(-20, 10); ctx.closePath(); ctx.fill();
            ctx.fillStyle = 'white'; ctx.fillRect(-1, -18, 2, 8); ctx.fillRect(-4, -15, 8, 2);
            ctx.restore();
        }
        shoot() { bullets.push(new Bullet(this.x, this.y - 30)); }
    }

    class Bullet {
        constructor(x, y) { this.x = x; this.y = y; this.speed = 20; this.active = true; }
        update() { this.y -= this.speed; if (this.y < -20) this.active = false; }
        draw() {
            ctx.fillStyle = '#fde047';
            ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI * 2); ctx.fill();
        }
    }

    class Enemy {
        constructor() {
            const level = LEVEL_DATA[currentLevelIdx];
            this.data = level.diseases[Math.floor(Math.random() * level.diseases.length)];
            this.type = level.type;
            this.x = Math.random() * (canvas.width - 100) + 50;
            this.y = -60;
            this.speed = 1.2 + (score / 10000);
            this.active = true;
            this.seed = Math.random() * 10;
        }
        update() { this.y += this.speed; if (this.y > canvas.height + 100) this.active = false; }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            const pulse = Math.sin(frameCount * 0.05 + this.seed) * 3;
            ctx.fillStyle = this.data.color;
            ctx.strokeStyle = this.data.color;

            if (this.type === 'fungi') {
                ctx.beginPath(); ctx.roundRect(-8, 0, 16, 20, 4); ctx.fill();
                ctx.beginPath(); ctx.ellipse(0, -5, 28 + pulse, 18 + pulse, 0, 0, Math.PI * 2); ctx.fill();
            } else if (this.type === 'virus') {
                ctx.lineWidth = 2;
                for(let i=0; i<6; i++) {
                    ctx.rotate(Math.PI/3); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, 30+pulse); ctx.stroke();
                }
                ctx.beginPath(); ctx.arc(0,0, 18+pulse, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.beginPath(); ctx.ellipse(0, 0, 28+pulse, 18-pulse, 0, 0, Math.PI * 2); ctx.fill();
            }

            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-8, -3, 5, 0, Math.PI*2); ctx.arc(8, -3, 5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-8, -3, 2, 0, Math.PI*2); ctx.arc(8, -3, 2, 0, Math.PI*2); ctx.fill();

            ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.roundRect(-55, 30, 110, 18, 5); ctx.fill();
            ctx.fillStyle = '#fde047'; ctx.font = 'italic bold 11px Arial'; ctx.textAlign = 'center'; ctx.fillText(this.data.sci, 0, 43);
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.vx = (Math.random()-0.5)*8; this.vy = (Math.random()-0.5)*8; this.alpha = 1; }
        update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.04; }
        draw() { ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
    }

    function refreshTarget() {
        const level = LEVEL_DATA[currentLevelIdx];
        currentTarget = level.diseases[Math.floor(Math.random() * level.diseases.length)];
        targetNameEl.innerText = currentTarget.cn;
        targetDescEl.innerText = currentTarget.info;
    }

    function checkLevelProgress() {
        if (score >= LEVEL_DATA[currentLevelIdx].goal) {
            if (currentLevelIdx < LEVEL_DATA.length - 1) {
                currentLevelIdx++;
                showLevelUpEffect();
                player.invincible = 100;
                refreshTarget();
                updateUI();
            } else { gameWin(); }
        }
    }

    function showLevelUpEffect() {
        const div = document.createElement('div');
        div.className = 'level-up-anim';
        div.innerText = 'LEVEL UP!';
        gameContainer.appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    function updateUI() {
        const level = LEVEL_DATA[currentLevelIdx];
        scoreEl.innerText = score;
        goalEl.innerText = level.goal;
        levelTitleEl.innerText = level.name;
        livesEl.innerText = lives;
    }

    function handleCollisions() {
        for (let bi = bullets.length - 1; bi >= 0; bi--) {
            const b = bullets[bi];
            for (let ei = enemies.length - 1; ei >= 0; ei--) {
                const e = enemies[ei];
                if (Math.hypot(b.x - e.x, b.y - e.y) < 35) {
                    bullets.splice(bi, 1);
                    if (e.data.sci === currentTarget.sci) {
                        score += 500;
                        for(let i=0; i<15; i++) particles.push(new Particle(e.x, e.y, e.data.color));
                        enemies.splice(ei, 1);
                        refreshTarget();
                        checkLevelProgress();
                    } else {
                        lives--;
                        gameContainer.classList.add('wrong-flash');
                        setTimeout(() => gameContainer.classList.remove('wrong-flash'), 400);
                        for(let i=0; i<10; i++) particles.push(new Particle(e.x, e.y, '#f00'));
                        enemies.splice(ei, 1);
                    }
                    updateUI();
                    if(lives <= 0) gameOver();
                    break;
                }
            }
        }
        for (let ei = enemies.length - 1; ei >= 0; ei--) {
            const e = enemies[ei];
            if (Math.hypot(player.x - e.x, player.y - e.y) < 32 && player.invincible <= 0) {
                lives--; player.invincible = 80; updateUI();
                if(lives <= 0) gameOver();
            }
        }
    }

    function gameOver() {
        gameState = 'GAMEOVER';
        menuOverlay.style.display = 'flex';
        fireBtn.style.display = 'none';
        document.getElementById('menu-title').innerText = '防疫失敗';
        document.getElementById('game-over-msg').innerHTML = `得分: ${score}<br>敗於${LEVEL_DATA[currentLevelIdx].name}`;
        startBtn.innerText = '重新挑戰';
    }

    function gameWin() {
        gameState = 'WIN';
        menuOverlay.style.display = 'flex';
        fireBtn.style.display = 'none';
        document.getElementById('menu-title').innerText = '農業英雄！';
        document.getElementById('game-over-msg').innerHTML = `恭喜過關！守護成功。<br>最終得分: ${score}`;
        startBtn.innerText = '再次挑戰';
    }

    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach(s => { 
            s.y += s.speed; 
            if (s.y > canvas.height) s.y = -10; 
            ctx.fillStyle = 'rgba(100,255,100,0.15)'; 
            ctx.fillRect(s.x, s.y, s.size, s.size); 
        });

        if (gameState === 'PLAYING') {
            frameCount++;
            if (frameCount % 105 === 0) enemies.push(new Enemy());
            player.update(); 
            player.draw();
            bullets.forEach((b, i) => { b.update(); b.draw(); if(!b.active) bullets.splice(i,1); });
            enemies.forEach((e, i) => { e.update(); e.draw(); if(!e.active) enemies.splice(i,1); });
            particles.forEach((p, i) => { p.update(); p.draw(); if(p.alpha<=0) particles.splice(i,1); });
            handleCollisions();
        }
        requestAnimationFrame(loop);
    }

    // 移動邏輯 (全螢幕感應，但不射擊)
    window.addEventListener('touchstart', (e) => {
        if(gameState === 'PLAYING') {
            // 如果點擊的不是射擊按鈕，則移動
            if(e.target !== fireBtn) {
                const touch = e.touches[0];
                player.targetX = touch.clientX;
                player.targetY = touch.clientY - 60;
            }
        }
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if(gameState === 'PLAYING') {
            const touch = Array.from(e.touches).find(t => t.target !== fireBtn) || e.touches[0];
            player.targetX = touch.clientX;
            player.targetY = touch.clientY - 60;
        }
        e.preventDefault();
    }, { passive: false });

    // 射擊按鈕邏輯
    fireBtn.addEventListener('touchstart', (e) => {
        if(gameState === 'PLAYING') {
            player.shoot();
        }
        e.stopPropagation(); // 防止觸發背景的移動邏輯
    }, { passive: false });

    // 滑鼠與鍵盤 (相容桌面)
    window.addEventListener('mousemove', (e) => {
        if(player && gameState === 'PLAYING') {
            player.targetX = e.clientX;
            player.targetY = e.clientY;
        }
    });
    window.addEventListener('keydown', (e) => { if (e.code === 'Space' && gameState === 'PLAYING') player.shoot(); });

    startBtn.addEventListener('click', () => {
        currentLevelIdx = 0; score = 0; lives = 10;
        player = new Player(); bullets = []; enemies = []; particles = [];
        refreshTarget(); updateUI();
        gameState = 'PLAYING';
        menuOverlay.style.display = 'none';
        fireBtn.style.display = 'flex';
    });

    fireBtn.style.display = 'none'; // 初始隱藏
    loop();
</script>

</body>
</html>
